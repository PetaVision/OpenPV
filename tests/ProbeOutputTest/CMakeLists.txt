get_filename_component(BASE_NAME ${CMAKE_CURRENT_SOURCE_DIR} NAME)

pv_add_executable(${BASE_NAME}
  SRC src/main.cpp
  OUTPUT_PATH
  "${CMAKE_CURRENT_BINARY_DIR}/${CMAKE_BUILD_TYPE}")
add_dependencies(${BASE_NAME} pv)
set(TEST_SOURCE_INPUT "${CMAKE_CURRENT_SOURCE_DIR}/input")
if (EXISTS "${TEST_SOURCE_INPUT}")
  set(TEST_BINARY_INPUT "${CMAKE_CURRENT_BINARY_DIR}/input")
  execute_process(COMMAND ${CMAKE_COMMAND} -E create_symlink ${TEST_SOURCE_INPUT} ${TEST_BINARY_INPUT})
else()
  message(FATAL_ERROR "Directory ${TEST_SOURCE_INPUT} is missing")
endif (EXISTS "${TEST_SOURCE_INPUT}")

set(TEST_SCRIPT_BASE "${CMAKE_CURRENT_BINARY_DIR}/input/testProbeOutput")
set(TEST_SCRIPT_ONEPROC "${TEST_SCRIPT_BASE}_oneproc.bash")
set(TEST_SCRIPT_BATCHMPI "${TEST_SCRIPT_BASE}_batchMPI.bash")
set(TEST_SCRIPT_MPIBLOCK "${TEST_SCRIPT_BASE}_MtoN.bash")
set(TEST_SCRIPT_MPIBLOCK2 "${TEST_SCRIPT_BASE}_MtoN2.bash")

add_test(
  NAME "${BASE_NAME}_oneproc"
  COMMAND bash ${TEST_SCRIPT_ONEPROC}
  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
)

if (MPI_FOUND AND PV_USE_MPI)
  add_test(
    NAME "${BASE_NAME}_batchMPI"
    COMMAND bash ${TEST_SCRIPT_BATCHMPI}
    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
  )
  if (PV_SYSTEM_TEST_MPIBLOCK)
    add_test(
      NAME "${BASE_NAME}_MtoN"
      COMMAND bash ${TEST_SCRIPT_MPIBLOCK}
      WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
    )
    add_test(
      NAME "${BASE_NAME}_MtoN2"
      COMMAND bash ${TEST_SCRIPT_MPIBLOCK2}
      WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
    )
  endif()
endif()
