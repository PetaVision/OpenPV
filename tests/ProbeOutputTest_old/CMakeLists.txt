get_filename_component(BASE_NAME ${CMAKE_CURRENT_SOURCE_DIR} NAME)

pv_add_executable(${BASE_NAME}
  SRC src/main.cpp
  OUTPUT_PATH
  "${CMAKE_CURRENT_BINARY_DIR}/${CMAKE_BUILD_TYPE}")
add_dependencies(${BASE_NAME} pv)
set(TEST_SOURCE_INPUT "${CMAKE_CURRENT_SOURCE_DIR}/input")
if (EXISTS "${TEST_SOURCE_INPUT}")
  set(TEST_BINARY_INPUT "${CMAKE_CURRENT_BINARY_DIR}/input")
  execute_process(COMMAND ${CMAKE_COMMAND} -E create_symlink ${TEST_SOURCE_INPUT} ${TEST_BINARY_INPUT})
else()
  message(FATAL_ERROR "Directory ${TEST_SOURCE_INPUT} is missing")
endif (EXISTS "${TEST_SOURCE_INPUT}")

set(TEST_SCRIPT_BASE "${CMAKE_CURRENT_BINARY_DIR}/input/testProbeOutput")
set(TEST_SCRIPT_ONEPROC "${TEST_SCRIPT_BASE}_oneproc.bash")
set(TEST_SCRIPT_BATCHMPI "${TEST_SCRIPT_BASE}_batchMPI.bash")
set(TEST_SCRIPT_MPIBLOCK "${TEST_SCRIPT_BASE}_MtoN.bash")
set(TEST_SCRIPT_MPIBLOCK2 "${TEST_SCRIPT_BASE}_MtoN2.bash")
get_filename_component(BASE_NAME ${CMAKE_CURRENT_SOURCE_DIR} NAME)
set(EXECUTABLE "${CMAKE_BUILD_TYPE}/${BASE_NAME}")

set(TEST_NAME "${BASE_NAME}_oneproc")
add_test(
  NAME "${TEST_NAME}"
  COMMAND bash ${TEST_SCRIPT_ONEPROC} ${EXECUTABLE}
  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
)
set(PREV_TEST_NAME "${TEST_NAME}")

if (MPI_FOUND AND PV_USE_MPI)
  set(TEST_NAME "${BASE_NAME}_batchMPI")
  add_test(
    NAME "${TEST_NAME}"
    COMMAND bash ${TEST_SCRIPT_BATCHMPI} ${EXECUTABLE}
    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
  )
  set_tests_properties(${TEST_NAME} PROPERTIES DEPENDS ${PREV_TEST_NAME})
  set(PREV_TEST_NAME "${TEST_NAME}")

  if (PV_SYSTEM_TEST_MPIBLOCK)
    set(TEST_NAME "${BASE_NAME}_MtoN")
    add_test(
      NAME "${TEST_NAME}"
      COMMAND bash ${TEST_SCRIPT_MPIBLOCK} ${EXECUTABLE}
      WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
    )
    set_tests_properties(${TEST_NAME} PROPERTIES DEPENDS ${PREV_TEST_NAME})
    set(PREV_TEST_NAME "${TEST_NAME}")

    set(TEST_NAME "${BASE_NAME}_MtoN2")
    add_test(
      NAME "${TEST_NAME}"
      COMMAND bash ${TEST_SCRIPT_MPIBLOCK2} ${EXECUTABLE}
      WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
    )
    set_tests_properties(${TEST_NAME} PROPERTIES DEPENDS ${PREV_TEST_NAME})
    set(PREV_TEST_NAME "${TEST_NAME}")
  endif()
endif()
