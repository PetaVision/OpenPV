# This CMakeLists.txt file bypasses pv_add_test because
# it uses a config file instead of setting the configuration
# on the command line, as pv_add_test has been assuming.
# TODO: cmake/PVAddTest.cmake needs to be config-file aware

set(SRC_CPP
  src/StatsProbeTest.cpp
)

get_filename_component(TEST_NAME_BASE ${CMAKE_CURRENT_SOURCE_DIR} NAME)
set(TEST_BINARY "${CMAKE_CURRENT_BINARY_DIR}/${CMAKE_BUILD_TYPE}/${TEST_NAME_BASE}")
set(TEST_TOP_DIR ${CMAKE_CURRENT_SOURCE_DIR})
set(TEST_SOURCE_DIR "${CMAKE_CURRENT_SOURCE_DIR}/src")
set(TEST_CONFIG_FILE_BASE "input/config")

include_directories("${TEST_TOP_DIR}/../Shared")
pv_add_executable(${TEST_NAME_BASE}
  SRC ${SRC_CPP}
  OUTPUT_PATH "${CMAKE_CURRENT_BINARY_DIR}/${CMAKE_BUILD_TYPE}")
add_dependencies(${TEST_NAME_BASE} pv)
if (NOT ${CMAKE_CURRENT_SOURCE_DIR} STREQUAL ${CMAKE_CURRENT_BINARY_DIR})
  set(TEST_SOURCE_INPUT "${CMAKE_CURRENT_SOURCE_DIR}/input")
  if (EXISTS "${TEST_SOURCE_INPUT}")
    set(TEST_BINARY_INPUT "${CMAKE_CURRENT_BINARY_DIR}/input")
    execute_process(COMMAND ${CMAKE_COMMAND} -E create_symlink ${TEST_SOURCE_INPUT} ${TEST_BINARY_INPUT})
  endif (EXISTS "${TEST_SOURCE_INPUT}")
endif()

set(TEST_NAME "${TEST_NAME_BASE}_1")
set(TEST_CONFIG_FILE "${TEST_CONFIG_FILE_BASE}_1.txt")
if (PV_MPI_SINGLE_PROCESS_TEST)
add_test(
  NAME ${TEST_NAME}
  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
  COMMAND ${MPIEXEC} ${MPIEXEC_NUMPROC_FLAG} 1 ${PV_MPI_OPTIONS_EXTRA} ${MPIEXEC_PREFLAGS} ${PV_SYSTEM_TEST_COMMAND} ${TEST_BINARY} ${TEST_CONFIG_FILE})
else()
add_test(
  NAME ${TEST_NAME}
  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
  COMMAND ${PV_SYSTEM_TEST_COMMAND} ${TEST_BINARY} ${TEST_CONFIG_FILE})
endif()

set(PREV_TEST_NAME "${TEST_NAME}")
set(TEST_NAME "${TEST_NAME_BASE}_4")
set(TEST_CONFIG_FILE "${TEST_CONFIG_FILE_BASE}_4.txt")
add_test(
  NAME ${TEST_NAME}
  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
  COMMAND ${MPIEXEC} ${MPIEXEC_NUMPROC_FLAG} 4 ${PV_MPI_OPTIONS_EXTRA} ${MPIEXEC_PREFLAGS} ${PV_SYSTEM_TEST_COMMAND} ${TEST_BINARY} ${TEST_CONFIG_FILE})
set_tests_properties(${TEST_NAME} PROPERTIES DEPENDS ${PREV_TEST_NAME})

set(PREV_TEST_NAME "${TEST_NAME}")
set(TEST_NAME "${TEST_NAME_BASE}_4batch")
set(TEST_CONFIG_FILE "${TEST_CONFIG_FILE_BASE}_4batch.txt")
add_test(
  NAME ${TEST_NAME}
  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
  COMMAND ${MPIEXEC} ${MPIEXEC_NUMPROC_FLAG} 4 ${PV_MPI_OPTIONS_EXTRA} ${MPIEXEC_PREFLAGS} ${PV_SYSTEM_TEST_COMMAND} ${TEST_BINARY} ${TEST_CONFIG_FILE})
set_tests_properties(${TEST_NAME} PROPERTIES DEPENDS ${PREV_TEST_NAME})

if (PV_SYSTEM_TEST_MPIBLOCK)
  set(PREV_TEST_NAME "${TEST_NAME}")
  set(TEST_NAME "${TEST_NAME_BASE}_8MtoN")
  set(TEST_CONFIG_FILE "${TEST_CONFIG_FILE_BASE}_8MtoN.txt")
  add_test(
    NAME ${TEST_NAME}
    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
    COMMAND ${MPIEXEC} ${MPIEXEC_NUMPROC_FLAG} 8 ${PV_MPI_OPTIONS_EXTRA} ${MPIEXEC_PREFLAGS} ${PV_SYSTEM_TEST_COMMAND} ${TEST_BINARY} ${TEST_CONFIG_FILE})
  set_tests_properties(${TEST_NAME} PROPERTIES DEPENDS ${PREV_TEST_NAME})
endif()
